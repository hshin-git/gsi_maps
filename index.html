<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>GSI Maps</title>

<link rel="stylesheet" href="dist/leaflet.css" />
<link rel="icon" type="image/png" href="./favicon/icon-192x192.png">
<link rel="apple-touch-icon" type="image/png" href="./favicon/apple-touch-icon-180x180.png">

<style type="text/css">
body { padding:0; margin:0; }
html, body, #mapContainer { height:100%; width:100vw; }
#hereButton {
  position:relative; top:10px; padding:10px; z-index:1000;
  border-style:none; font-weight:bold; border-radius:8px; background-color:gold; 
}
.buttonLayout { text-align:center; }
</style>

<script src="dist/leaflet.js"></script>
<script src="dist/leaflet.geocsv.js"></script>
<script>
////////// SCRIPT BEGIN
// GFS天気予報
function sdpIcon(feature,latlng) {
  return L.marker(latlng,{icon:L.icon({iconUrl:feature.properties["icon"],iconSize:[32,32],}),});
};
function sdpText(feature,layer) {
  //alert(Object.keys(feature.properties));
  var html = "<center>";
  html += "GFS天気予報 " + feature.properties["fuken"] + " " + feature.properties["name"] + "<br>";
  html += feature.properties["html"];
  html += feature.properties["time"]; 
  html += "</center>"
  layer.bindPopup(html);
};
var SDP_LAYER = null;
function getSDP_LAYER() {
  if (SDP_LAYER != null) { return; };
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if(req.readyState == 4 && req.status == 200){
      SDP_LAYER = L.geoCsv(req.responseText,{firstLineTitles:true, latitudeTitle:'lat', longitudeTitle:'lon', fieldSeparator:',', onEachFeature:sdpText, pointToLayer:sdpIcon,});
    }
  };
  req.open("GET", "./sdp_layer.csv", false);
  req.send(null);
};
getSDP_LAYER();
//
function GSI_URL(KEY,EXT) { return "http://cyberjapandata.gsi.go.jp/xyz/"+KEY+"/{z}/{x}/{y}."+EXT; };
function GSI_OPT(MIN,MAX,OPA) { return {opacity:OPA, /*minNativeZoom:MIN,*/ maxNativeZoom:MAX, attribution:"<a href='https://maps.gsi.go.jp/development/ichiran.html'>国土地理院</a>" }; };
function MAP_OPT(MIN,MAX,OPA) { return {opacity:OPA, /*minNativeZoom:MIN,*/ maxNativeZoom:MAX, attribution:"AIST/OSM/OPTM/WMT" }; };
// ベース地図の定義
const BASE = 1.0;
const baseTiles = {
  "GSI 淡色地図":	L.tileLayer(GSI_URL("pale","png"),GSI_OPT(5,18,BASE)),
  "GSI 標準地図":	L.tileLayer(GSI_URL("std","png"),GSI_OPT(5,18,BASE)),
  "GSI 白地図":		L.tileLayer(GSI_URL("blank","png"),GSI_OPT(5,14,BASE)),
  "GSI 英語地図":	L.tileLayer(GSI_URL("english","png"),GSI_OPT(5,11,BASE)),
  "OSM 標準地図":	L.tileLayer('http://tile.openstreetmap.jp/{z}/{x}/{y}.png',MAP_OPT(2,18,BASE)),
  "OSM 白黒図":		L.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png',MAP_OPT(2,16,BASE)),
  "OSM 地形図":		L.tileLayer('http://tile.stamen.com/terrain/{z}/{x}/{y}.png',MAP_OPT(2,16,BASE)),
  "OSM 水彩画":		L.tileLayer('http://tile.stamen.com/watercolor/{z}/{x}/{y}.png',MAP_OPT(2,16,BASE)),
};
// レイヤ地図の定義
const OVER = 0.7;
const overTiles = {
  "GSI 色別標高図":	L.tileLayer(GSI_URL("relief","png"),GSI_OPT(5,15,OVER)),
  "GSI 陰影起伏図":	L.tileLayer(GSI_URL("hillshademap","png"),GSI_OPT(2,16,OVER)),
//"GSI 赤色立体図":	L.tileLayer(GSI_URL("sekishoku","png"),GSI_OPT(2,14,OVER)),
//"GSI 傾斜量図":	L.tileLayer(GSI_URL("slopemap","png"),GSI_OPT(3,15,OVER)),
  "GSI 傾斜量区分図":	L.tileLayer(GSI_URL("slopezone1map","png"),GSI_OPT(3,15,OVER)),
  "GSI 活断層図":	L.tileLayer(GSI_URL("afm","png"),GSI_OPT(11,16,OVER)),
  "GSI 土地条件図":	L.tileLayer(GSI_URL("lcm25k_2012","png"),GSI_OPT(10,16,OVER)),
//"GSI 土地条件図":	L.tileLayer(GSI_URL("lcm25k","png"),GSI_OPT(14,16,OVER)),
  "GSI 治水地形分類":	L.tileLayer(GSI_URL("lcmfc2","png"),GSI_OPT(11,16,OVER)),
  "GSI 明治の低湿地":	L.tileLayer(GSI_URL("swale","png"),GSI_OPT(10,16,OVER)),
  "GSI 航空写真":	L.tileLayer(GSI_URL("seamlessphoto","jpg"),GSI_OPT(2,18,OVER)),
  "GSI 1988-1990年":	L.tileLayer(GSI_URL("gazo4","jpg"),GSI_OPT(10,17,OVER)),
  "GSI 1984-1986年":	L.tileLayer(GSI_URL("gazo3","jpg"),GSI_OPT(10,17,OVER)),
  "GSI 1979-1983年":	L.tileLayer(GSI_URL("gazo2","jpg"),GSI_OPT(10,17,OVER)),
  "GSI 1974-1978年":	L.tileLayer(GSI_URL("gazo1","jpg"),GSI_OPT(10,17,OVER)),
  "GSI 1961-1969年":	L.tileLayer(GSI_URL("ort_old10","png"),GSI_OPT(10,17,OVER)),
  "GSI 1945-1950年":	L.tileLayer(GSI_URL("ort_USA10","png"),GSI_OPT(10,17,OVER)),
  "AIST 地質図":	L.tileLayer('https://gbank.gsj.jp/seamless/v2/api/1.2/tiles/{z}/{y}/{x}.png',MAP_OPT(10,13,OVER)),
  "OPTM 公共交通":	L.tileLayer('http://www.openptmap.org/tiles/{z}/{x}/{y}.png',MAP_OPT(4,17,BASE)),
//"ORM 鉄道路線":	L.tileLayer('http://tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png',MAP_OPT(2,19,BASE)),
//"OSM 航路標識":	L.tileLayer('http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png',MAP_OPT(4,18,BASE)),
//"WMT ハイキング":	L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png',MAP_OPT(5,16,BASE)),
//"WMT サイクリング":	L.tileLayer('https://tile.waymarkedtrails.org/cycling/{z}/{x}/{y}.png',MAP_OPT(5,16,BASE)),
  "GFS 天気予報":	SDP_LAYER,
};
// 地図作成
var thisMap = null;
function _onLoad() {
  // 地図初期化
  thisMap = L.map('mapContainer',{zoomControl:false});
  thisMap.setView([38.0,137.0], 5);
  thisMap.on('locationfound', onLocationFound);
  thisMap.on('locationerror', onLocationError);
  // レイヤ登録
  L.control.scale().addTo(thisMap);
  L.control.zoom().addTo(thisMap);
  L.control.layers(baseTiles,overTiles).addTo(thisMap);
  baseTiles["GSI 淡色地図"].addTo(thisMap);
};
// 現在位置
var hereMarker = null;
var hereCircle = null;
function onLocationFound(e) {
  const now = new Date();
  const nowStr = ("0"+now.getHours()).slice(-2) +":"+ ("0"+now.getMinutes()).slice(-2) +":"+ ("0"+now.getSeconds()).slice(-2) 
  const radius = e.accuracy / 2;
  if (hereMarker) {
    thisMap.removeLayer(hereMarker);
    //thisMap.removeLayer(hereCircle); 
  };
  hereMarker = L.marker(e.latlng).addTo(thisMap).bindPopup("You were here at " + nowStr).openPopup();
  //hereCircle = L.circle(e.latlng, radius).addTo(thisMap);
};
function onLocationError(e) {
  alert(e.message);
};
function _hereButton() {
  thisMap.locate({setView:true, maxZoom:16});
};
////////// SCRIPT END
</script>
</head>

<body onload="_onLoad()">
<div id="mapContainer">
<div class="buttonLayout"><button id="hereButton" onClick="_hereButton()">Locate</button></div>
</div>
</body>

</html>
